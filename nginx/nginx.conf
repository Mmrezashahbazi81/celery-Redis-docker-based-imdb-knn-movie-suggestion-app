events {
    worker_connections 1024;
}

http {
    upstream mixed_backend {
        server flask-web:5000;
        server fast-web:8000;
    }

    upstream auth_service {
        server fast-web:8000;
    }

    server {
        listen 80;

        # =========================================================
        # 1. مسیرهای عمومی (Public) - بدون نیاز به توکن
        # =========================================================
        
        # لاگین و دریافت توکن (باز است)
        location /auth/token {
            proxy_pass http://auth_service/auth/token;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # رفرش توکن (جدید - باز است چون توکن قبلی منقضی شده)
        location /auth/refresh {
            proxy_pass http://auth_service/auth/refresh;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # داکیومنت‌ها (اختیاری)
        location /docs {
            proxy_pass http://auth_service/docs;
        }
        location /openapi.json {
            proxy_pass http://auth_service/openapi.json;
        }

        # =========================================================
        # 2. مسیر داخلی اعتبارسنجی (Internal)
        # =========================================================
        location = /_auth_verify {
            internal;
            proxy_pass http://auth_service/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }

        # =========================================================
        # 3. مسیرهای محافظت شده (Protected) - همه چیز دیگر
        # =========================================================
        location / {
            auth_request /_auth_verify;
            
            # اگر 401 داد، Nginx ارور می‌دهد.
            # اگر 200 داد، می‌فرستد به بک‌اند اصلی.
            
            proxy_pass http://mixed_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
