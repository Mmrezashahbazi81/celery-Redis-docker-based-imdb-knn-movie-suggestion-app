events {
    worker_connections 1024;
}

http {
    # گروه بک‌اند ترکیبی (Flask + FastAPI)
    upstream mixed_backend {
        server flask-web:5000;
        server fast-web:8000;
    }

    # گروه سرویس احراز هویت (فقط FastAPI)
    upstream auth_service {
        server fast-web:8000;
    }

    server {
        listen 80;
        
        # روت فایل‌های استاتیک (برای UI)
        root /usr/share/nginx/html;
        index index.html;

        # =========================================================
        # 1. سرویس‌دهی UI (صفحه اصلی)
        # =========================================================
        location = / {
            try_files $uri /index.html;
        }
        
        # فایل‌های استاتیک دیگر (اگر داشته باشید، مثل CSS/JS)
        location ~ \.(js|css|png|jpg|jpeg|gif|ico)$ {
            try_files $uri =404;
        }

        # =========================================================
        # 2. مسیرهای عمومی API (Public)
        # =========================================================
        
        # لاگین و دریافت توکن
        location /auth/token {
            proxy_pass http://auth_service/auth/token;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # رفرش توکن
        location /auth/refresh {
            proxy_pass http://auth_service/auth/refresh;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # داکیومنت‌ها
        location /docs {
            proxy_pass http://auth_service/docs;
        }
        location /openapi.json {
            proxy_pass http://auth_service/openapi.json;
        }

        # =========================================================
        # 3. مسیر داخلی اعتبارسنجی (Internal)
        # =========================================================
        location = /_auth_verify {
            internal;
            proxy_pass http://auth_service/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }

        # =========================================================
        # 4. مسیرهای محافظت شده API (Protected)
        # =========================================================
        
        # اینجا از Regex استفاده می‌کنیم تا فقط مسیرهای خاص API را بگیریم.
        # هر درخواستی که با /movies یا /scrape یا /predict شروع شود -> محافظت شده است.
        location ~ ^/(movies|scrape|predict|test-task) {
            # اول چک کن کاربر لاگین است؟
            auth_request /_auth_verify;
            
            # اگر اوکی بود، بفرست به بک‌اند اصلی
            proxy_pass http://mixed_backend;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
