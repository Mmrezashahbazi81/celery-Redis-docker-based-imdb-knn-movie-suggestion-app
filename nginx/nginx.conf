events {
    worker_connections 1024;
}

http {
    upstream mixed_backend {
        server flask-web:5000;
        server fast-web:8000;
    }

    # گروه جداگانه برای سرویس Auth (فقط FastAPI)
    upstream auth_service {
        server fast-web:8000;
    }

    server {
        listen 80;

        # =========================================================
        # 1. مسیرهای عمومی (Public) - بدون نیاز به توکن
        # =========================================================
        
        # لاگین و دریافت توکن (باید باز باشد تا بتوانیم توکن بگیریم)
        location /auth/token {
            proxy_pass http://auth_service/auth/token;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # مستندات Swagger (اختیاری: اگر می‌خواهید باز باشد)
        location /docs {
            proxy_pass http://auth_service/docs;
        }
        location /openapi.json {
            proxy_pass http://auth_service/openapi.json;
        }

        # =========================================================
        # 2. مسیر داخلی برای اعتبارسنجی توکن (Internal)
        # =========================================================
        # این مسیر را فقط خود Nginx می‌تواند صدا بزند، نه کاربر
        location = /_auth_verify {
            internal;
            
            # درخواست را می‌فرستد به اندپوینت وریفای در FastAPI
            proxy_pass http://auth_service/auth/verify;
            
            # بدنه درخواست اصلی را به Auth نفرست (بهینه‌سازی)
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            
            # هدر Authorization را حتماً بفرست
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }

        # =========================================================
        # 3. مسیرهای محافظت شده (Protected) - پیش‌فرض برای همه چیز
        # =========================================================
        
        # هر درخواستی که به جز موارد بالا باشد، به اینجا می‌آید
        location / {
            # --- دستور جادویی ---
            # قبل از هر کاری، یک درخواست به /_auth_verify بفرست.
            # اگر 200 بود -> ادامه بده.
            # اگر 401/403 بود -> همانجا به کاربر ارور بده.
            auth_request /_auth_verify;
            
            # اگر Auth موفق بود، درخواست را به بک‌اند اصلی (Flask/FastAPI) بفرست
            proxy_pass http://mixed_backend;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # اگر بخواهیم یوزرنیم را به سرویس‌های بعدی پاس بدهیم (اختیاری):
            # auth_request_set $user $upstream_http_x_user;
            # proxy_set_header X-User $user;
        }
    }
}
